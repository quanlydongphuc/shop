<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n l√Ω b√°n ƒë·ªìng ph·ª•c</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .toast { position: fixed; bottom: 20px; right: 20px; background: #4ade80; color: white; padding: 10px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.3s;}
    .toast.show { opacity: 1; }
    td.num, th.num { text-align: right; width: 90px; }
    td.total-order, th.total-order { min-width: 140px; text-align: right; }
  </style>
</head>
<body class="bg-blue-50 min-h-screen">
  <div class="max-w-7xl mx-auto p-6">
    <!-- Menu -->
    <div class="flex flex-wrap gap-2 mb-6">
      <button onclick="showSection('prices')" class="px-3 py-2 bg-blue-200 rounded text-sm">Gi√° b√°n</button>
      <button onclick="showSection('manage')" class="px-3 py-2 bg-blue-200 rounded text-sm">Nh·∫≠p/B√°n</button>
      <button onclick="showSection('inventory')" class="px-3 py-2 bg-blue-200 rounded text-sm">T·ªìn kho</button>
      <button onclick="showSection('importHistory')" class="px-3 py-2 bg-blue-200 rounded text-sm">L·ªãch s·ª≠ nh·∫≠p</button>
      <button onclick="showSection('salesHistory')" class="px-3 py-2 bg-blue-200 rounded text-sm">L·ªãch s·ª≠ b√°n</button>
    </div>

    <!-- Th√™m n√∫t Export/Import -->
    <div class="flex space-x-2 mb-4">
      <button onclick="exportData()" class="px-3 py-1 bg-green-500 text-white rounded">Export Data</button>
      <button onclick="importData()" class="px-3 py-1 bg-blue-500 text-white rounded">Import Data</button>
      <input type="file" id="importFile" accept=".json" style="display: none">
    </div>

    <!-- Gi√° b√°n -->
    <div id="prices" class="hidden">
      <h2 class="text-xl font-bold mb-4">B·∫£ng gi√°</h2>
      <table class="table-auto border-collapse border w-full bg-white">
        <thead class="bg-blue-100">
          <tr><th class="border px-2">S·∫£n ph·∫©m</th><th class="border px-2 num">Gi√°</th></tr>
        </thead>
        <tbody id="priceTable"></tbody>
      </table>
    </div>

    <!-- Nh·∫≠p / B√°n -->
    <div id="manage" class="hidden">
      <h2 class="text-xl font-bold mb-4">Nh·∫≠p h√†ng / B√°n h√†ng</h2>
      <div class="flex space-x-6">
        <!-- Grid s·∫£n ph·∫©m -->
        <div class="grid grid-cols-4 gap-3 w-2/3" id="productGrid"></div>
        <!-- Gi·ªè h√†ng -->
        <div class="w-1/3 bg-white rounded-xl shadow p-4">
          <div class="flex justify-between items-center mb-3">
            <h3 class="font-bold text-lg">üõí Gi·ªè h√†ng</h3>
            <button onclick="clearCart()" class="bg-red-500 text-white px-3 py-1 rounded text-sm flex items-center">
              üóëÔ∏è X√≥a t·∫•t c·∫£
            </button>
          </div>
          <table class="table-auto border w-full text-sm">
            <thead>
              <tr class="bg-gray-100">
                <th class="border">S·∫£n ph·∫©m</th>
                <th class="border num">SL</th>
                <th class="border num">Gi√°</th>
                <th class="border num">Ti·ªÅn</th>
                <th class="border">Ghi ch√∫</th>
                <th class="border">‚ùå</th>
              </tr>
            </thead>
            <tbody id="cartTable"></tbody>
          </table>
          <button onclick="confirmSale()" class="mt-4 w-full bg-green-500 text-white py-2 rounded">X√°c nh·∫≠n b√°n</button>
        </div>
      </div>
    </div>

    <!-- T·ªìn kho -->
    <div id="inventory" class="hidden">
      <div class="flex justify-between items-center mb-2">
        <div>
          <h2 class="text-xl font-bold">T·ªìn kho</h2>
          <div id="totalInventoryValue" class="text-sm text-gray-600 mt-1"></div>
        </div>
        <button onclick="clearInventory()" class="bg-red-400 text-white px-3 py-1 rounded">X√≥a t·∫•t c·∫£</button>
      </div>
      <table class="table-auto border w-full bg-white">
        <thead class="bg-blue-100">
          <tr>
            <th class="border">S·∫£n ph·∫©m</th>
            <th class="border num">S·ªë l∆∞·ª£ng nh·∫≠p</th>
            <th class="border num">S·ªë l∆∞·ª£ng b√°n</th>
            <th class="border num">T·ªìn</th>
          </tr>
        </thead>
        <tbody id="inventoryTable"></tbody>
      </table>
    </div>

    <!-- L·ªãch s·ª≠ nh·∫≠p -->
    <div id="importHistory" class="hidden">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-xl font-bold">L·ªãch s·ª≠ nh·∫≠p h√†ng</h2>
        <button onclick="clearImportHistory()" class="bg-red-400 text-white px-3 py-1 rounded">X√≥a t·∫•t c·∫£</button>
      </div>
      <table class="table-auto border w-full bg-white">
        <thead class="bg-blue-100">
          <tr><th class="border">Th·ªùi gian</th><th class="border">S·∫£n ph·∫©m</th><th class="border num">S·ªë l∆∞·ª£ng</th></tr>
        </thead>
        <tbody id="importHistoryTable"></tbody>
      </table>
    </div>

    <!-- L·ªãch s·ª≠ b√°n -->
    <div id="salesHistory" class="hidden">
      <div class="flex justify-between items-center mb-2">
        <div>
          <h2 class="text-xl font-bold">L·ªãch s·ª≠ b√°n h√†ng</h2>
          <div id="totalSalesValue" class="text-sm text-gray-600 mt-1"></div>
        </div>
        <button onclick="clearSalesHistory()" class="bg-red-400 text-white px-3 py-1 rounded">X√≥a t·∫•t c·∫£</button>
      </div>
      <table class="table-auto border w-full bg-white">
        <thead class="bg-blue-100">
          <tr>
            <th class="border">Th·ªùi gian</th>
            <th class="border">S·∫£n ph·∫©m</th>
            <th class="border num">S·ªë l∆∞·ª£ng</th>
            <th class="border num">Gi√°</th>
            <th class="border num">Th√†nh ti·ªÅn</th>
            <th class="border">Ghi ch√∫</th>
            <th class="border num total-order">T·ªïng ƒë∆°n h√†ng</th>
          </tr>
        </thead>
        <tbody id="salesHistoryTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Popup Form -->
  <div id="popup" class="hidden fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center">
    <div class="bg-white p-6 rounded-xl w-96">
      <h3 class="font-bold text-lg mb-4" id="popupTitle"></h3>
      <label class="block mb-2">S·ªë l∆∞·ª£ng nh·∫≠p:</label>
      <input id="inputImport" type="number" min="0" class="border rounded w-full mb-3 p-2">
      <label class="block mb-2">S·ªë l∆∞·ª£ng b√°n:</label>
      <input id="inputSell" type="number" min="0" class="border rounded w-full mb-3 p-2">
      <label class="block mb-2">Ghi ch√∫:</label>
      <input id="inputNote" type="text" class="border rounded w-full mb-3 p-2">
      <div class="flex justify-end space-x-3">
        <button onclick="closePopup()" class="px-3 py-1 bg-gray-300 rounded">H·ªßy</button>
        <button onclick="submitPopup()" class="px-3 py-1 bg-blue-500 text-white rounded">OK</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const prices = JSON.parse(localStorage.getItem("prices")) || {};
    const importTotals = JSON.parse(localStorage.getItem("importTotals")) || {};
    const sellTotals = JSON.parse(localStorage.getItem("sellTotals")) || {};
    const importHistory = JSON.parse(localStorage.getItem("importHistory")) || [];
    const salesHistory = JSON.parse(localStorage.getItem("salesHistory")) || [];
    let cart = JSON.parse(localStorage.getItem("cart")) || [];
    let currentProduct = null;

    // Gi√° v·ªën
    const costPrices = {
      "ƒê·ªìng ph·ª•c Nam": 90000,
      "ƒê·ªìng ph·ª•c N·ªØ": 90000,
      "Th·ªÉ d·ª•c": 55000
    };

    function saveData() {
      localStorage.setItem("prices", JSON.stringify(prices));
      localStorage.setItem("importTotals", JSON.stringify(importTotals));
      localStorage.setItem("sellTotals", JSON.stringify(sellTotals));
      localStorage.setItem("importHistory", JSON.stringify(importHistory));
      localStorage.setItem("salesHistory", JSON.stringify(salesHistory));
      localStorage.setItem("cart", JSON.stringify(cart));
    }

    function initPrices() {
      if(Object.keys(prices).length>0) return;
      const add = (type, size, price) => prices[`${type} ${size}`] = price;
      ["ƒê·ªìng ph·ª•c Nam","ƒê·ªìng ph·ª•c N·ªØ"].forEach(type=>{
        [2,3,4,5].forEach(s=>add(type,s,110000));
        add(type,6,115000);
        [7,8,10].forEach(s=>add(type,s,120000));
      });
      [2,3,4,5].forEach(s=>add("Th·ªÉ d·ª•c",s,65000));
      [6,7].forEach(s=>add("Th·ªÉ d·ª•c",s,70000));
      [8,10].forEach(s=>add("Th·ªÉ d·ª•c",s,75000));
    }

    function renderPrices() {
      const tbody = document.getElementById("priceTable");
      tbody.innerHTML = "";
      Object.entries(prices).forEach(([k,v])=>{
        tbody.innerHTML += `<tr>
          <td class="border px-2">${k}</td>
          <td class="border px-2 num">${v.toLocaleString()}</td>
        </tr>`;
      });
    }

    // H√†m t√≠nh t·ªïng ti·ªÅn t·ªìn kho
    function calculateTotalInventoryValue() {
      let totalValue = 0;
      
      Object.keys(prices).forEach(key => {
        const imported = importTotals[key] || 0;
        const sold = sellTotals[key] || 0;
        const remain = imported - sold;
        
        // X√°c ƒë·ªãnh lo·∫°i s·∫£n ph·∫©m ƒë·ªÉ l·∫•y gi√° v·ªën
        let costPrice = 0;
        if (key.includes("ƒê·ªìng ph·ª•c Nam") || key.includes("ƒê·ªìng ph·ª•c N·ªØ")) {
          costPrice = costPrices["ƒê·ªìng ph·ª•c Nam"];
        } else if (key.includes("Th·ªÉ d·ª•c")) {
          costPrice = costPrices["Th·ªÉ d·ª•c"];
        }
        
        totalValue += remain * costPrice;
      });
      
      return totalValue;
    }

    // H√†m t√≠nh t·ªïng ti·ªÅn b√°n h√†ng
    function calculateTotalSalesValue() {
      let totalSales = 0;
      const processedTxIds = new Set();
      
      salesHistory.forEach(sale => {
        // Ch·ªâ t√≠nh m·ªói giao d·ªãch m·ªôt l·∫ßn (tr√°nh t√≠nh tr√πng)
        if (!processedTxIds.has(sale.txId) && sale.total) {
          totalSales += sale.total;
          processedTxIds.add(sale.txId);
        }
      });
      
      return totalSales;
    }

    function renderInventory() {
      const tbody = document.getElementById("inventoryTable");
      tbody.innerHTML = "";

      // Hi·ªÉn th·ªã to√†n b·ªô danh s√°ch s·∫£n ph·∫©m gi·ªëng nh∆∞ b√™n Gi√° b√°n
      Object.keys(prices).forEach(key => {
        const imported = importTotals[key] || 0;
        const sold = sellTotals[key] || 0;
        const remain = imported - sold;
        
        tbody.innerHTML += `<tr>
          <td class="border px-2">${key}</td>
          <td class="border px-2 num">${imported}</td>
          <td class="border px-2 num">${sold}</td>
          <td class="border px-2 num">${remain}</td>
        </tr>`;
      });

      // Hi·ªÉn th·ªã t·ªïng ti·ªÅn t·ªìn kho
      const totalInventoryValue = calculateTotalInventoryValue();
      document.getElementById("totalInventoryValue").textContent = `T·ªïng ti·ªÅn t·ªìn: ${totalInventoryValue.toLocaleString()}`;
    }

    function renderProducts() {
      const grid = document.getElementById("productGrid");
      grid.innerHTML = "";
      const colors = {"ƒê·ªìng ph·ª•c Nam":"bg-blue-300","ƒê·ªìng ph·ª•c N·ªØ":"bg-pink-200","Th·ªÉ d·ª•c":"bg-yellow-200"};
      ["ƒê·ªìng ph·ª•c Nam","ƒê·ªìng ph·ª•c N·ªØ","Th·ªÉ d·ª•c"].forEach(type=>{
        [2,3,4,5,6,7,8,10].forEach(size=>{
          grid.innerHTML += `<button onclick="openPopup('${type}',${size})" class="p-4 rounded-xl shadow ${colors[type]}">${type} ${size}</button>`;
        });
      });
    }

    function openPopup(type,size){
      currentProduct = {type,size};
      document.getElementById("popupTitle").textContent = `${type} ${size}`;
      document.getElementById("inputImport").value="";
      document.getElementById("inputSell").value="";
      document.getElementById("inputNote").value="";
      document.getElementById("popup").classList.remove("hidden");
    }

    function closePopup(){
      document.getElementById("popup").classList.add("hidden");
    }

    function submitPopup(){
      const importQty = parseInt(document.getElementById("inputImport").value)||0;
      const sellQty = parseInt(document.getElementById("inputSell").value)||0;
      const note = document.getElementById("inputNote").value||"";
      const key = `${currentProduct.type} ${currentProduct.size}`;

      if(importQty>0){
        importTotals[key]=(importTotals[key]||0)+importQty;
        importHistory.push({time:new Date().toLocaleString(),product:key,qty:importQty});
        showToast("ƒê√£ nh·∫≠p h√†ng th√†nh c√¥ng");
        
        // T·ª± ƒë·ªông chuy·ªÉn ƒë·∫øn tab T·ªìn kho sau khi nh·∫≠p h√†ng
        showSection('inventory');
      }

      if(sellQty>0){
        const remain = (importTotals[key]||0) - (sellTotals[key]||0);
        if(sellQty>remain){
          alert(`Kh√¥ng ƒë·ªß t·ªìn kho! Ch·ªâ c√≤n ${remain} s·∫£n ph·∫©m.`);
          return;
        }
        cart.push({product:key,qty:sellQty,note});
        renderCart();
        
        // T·ª± ƒë·ªông chuy·ªÉn ƒë·∫øn tab Qu·∫£n l√Ω sau khi th√™m v√†o gi·ªè h√†ng
        showSection('manage');
      }

      saveData();
      renderImportHistory();
      closePopup();
    }

    function renderCart() {
      const tbody = document.getElementById("cartTable");
      tbody.innerHTML = "";
      
      if (cart.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="border px-2 text-center py-4">Gi·ªè h√†ng tr·ªëng</td></tr>`;
        return;
      }
      
      cart.forEach((item,i)=>{
        const price = prices[item.product];
        const money = price*item.qty;
        tbody.innerHTML += `<tr>
          <td class="border">${item.product}</td>
          <td class="border num">${item.qty}</td>
          <td class="border num">${price.toLocaleString()}</td>
          <td class="border num">${money.toLocaleString()}</td>
          <td class="border">${item.note||""}</td>
          <td class="border text-center"><button onclick="removeFromCart(${i})" class="text-red-500 hover:text-red-700">‚ùå</button></td>
        </tr>`;
      });
      saveData();
    }

    function removeFromCart(i) {
      cart.splice(i,1);
      renderCart();
      showToast("ƒê√£ x√≥a s·∫£n ph·∫©m kh·ªèi gi·ªè h√†ng");
    }

    // H√†m x√≥a to√†n b·ªô gi·ªè h√†ng
    function clearCart() {
      if (cart.length === 0) {
        alert("Gi·ªè h√†ng ƒë√£ tr·ªëng!");
        return;
      }
      
      if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô gi·ªè h√†ng?")) {
        cart = [];
        renderCart();
        showToast("ƒê√£ x√≥a to√†n b·ªô gi·ªè h√†ng");
      }
    }

    function confirmSale() {
      if(cart.length===0){alert("Gi·ªè h√†ng tr·ªëng!");return;}
      const txId = Date.now();
      let total=0;
      cart.forEach(item=>{
        const price = prices[item.product];
        const money = price*item.qty;
        sellTotals[item.product]=(sellTotals[item.product]||0)+item.qty;
        salesHistory.push({
          time:new Date().toLocaleString(),
          product:item.product,
          qty:item.qty,
          price,
          money,
          note:item.note,
          txId
        });
        total+=money;
      });
      // Th√™m t·ªïng ti·ªÅn v√†o t·∫•t c·∫£ c√°c s·∫£n ph·∫©m trong c√πng m·ªôt giao d·ªãch
      salesHistory.forEach(item => {
        if (item.txId === txId) {
          item.total = total;
        }
      });

      cart=[];
      renderCart(); renderInventory(); renderSalesHistory();
      showToast("ƒê√£ b√°n h√†ng th√†nh c√¥ng");
      saveData();
    }

    function renderImportHistory() {
      const tbody = document.getElementById("importHistoryTable");
      tbody.innerHTML="";
      importHistory.forEach(r=>{
        tbody.innerHTML+=`<tr>
          <td class="border">${r.time}</td>
          <td class="border">${r.product}</td>
          <td class="border num">${r.qty}</td>
        </tr>`;
      });
    }

    function renderSalesHistory() {
      const tbody = document.getElementById("salesHistoryTable");
      tbody.innerHTML="";
      const grouped = {};
      
      // Nh√≥m c√°c s·∫£n ph·∫©m theo m√£ giao d·ªãch
      salesHistory.forEach(r=>{
        if(!grouped[r.txId]) grouped[r.txId]=[];
        grouped[r.txId].push(r);
      });

      // Hi·ªÉn th·ªã t·ª´ng ƒë∆°n h√†ng
      Object.values(grouped).forEach(rows=>{
        // S·∫Øp x·∫øp theo th·ªùi gian ƒë·ªÉ ƒë·∫£m b·∫£o th·ª© t·ª±
        rows.sort((a, b) => new Date(a.time) - new Date(b.time));
        
        // Hi·ªÉn th·ªã t·ª´ng s·∫£n ph·∫©m trong ƒë∆°n h√†ng
        rows.forEach((r,i)=>{
          tbody.innerHTML+=`<tr>
            <td class="border">${r.time}</td>
            <td class="border">${r.product}</td>
            <td class="border num">${r.qty}</td>
            <td class="border num">${r.price.toLocaleString()}</td>
            <td class="border num">${r.money.toLocaleString()}</td>
            <td class="border">${r.note||""}</td>
            ${i===0 ? `<td class="border num total-order" rowspan="${rows.length}">${r.total.toLocaleString()}</td>` : ""}
          </tr>`;
        });
      });

      // Hi·ªÉn th·ªã t·ªïng ti·ªÅn b√°n h√†ng
      const totalSalesValue = calculateTotalSalesValue();
      document.getElementById("totalSalesValue").textContent = `T·ªïng s·ªë ti·ªÅn b√°n: ${totalSalesValue.toLocaleString()}`;
    }

    function clearImportHistory(){ 
      if(confirm("X√≥a t·∫•t c·∫£ l·ªãch s·ª≠ nh·∫≠p?")){
        importHistory.length=0;
        renderImportHistory();
        saveData();
      }
    }
    
    function clearSalesHistory(){ 
      if(confirm("X√≥a t·∫•t c·∫£ l·ªãch s·ª≠ b√°n?")){
        salesHistory.length=0;
        renderSalesHistory();
        saveData();
      }
    }
    
    function clearInventory(){ 
      if(confirm("X√≥a to√†n b·ªô t·ªìn kho?")){
        Object.keys(importTotals).forEach(k=>importTotals[k]=0);
        Object.keys(sellTotals).forEach(k=>sellTotals[k]=0);
        renderInventory();
        saveData();
      }
    }

    function showToast(msg){
      const t=document.getElementById("toast");
      t.textContent=msg;t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"),2000);
    }

    function showSection(id){
      ["prices","manage","inventory","importHistory","salesHistory"].forEach(sec=>{
        document.getElementById(sec).classList.add("hidden");
      });
      document.getElementById(id).classList.remove("hidden");
      if(id==="prices")renderPrices();
      if(id==="inventory")renderInventory();
      if(id==="importHistory")renderImportHistory();
      if(id==="salesHistory")renderSalesHistory();
    }

    // H√†m export data
    function exportData() {
        const data = {
            prices: JSON.parse(localStorage.getItem("prices") || "{}"),
            importTotals: JSON.parse(localStorage.getItem("importTotals") || "{}"),
            sellTotals: JSON.parse(localStorage.getItem("sellTotals") || "{}"),
            importHistory: JSON.parse(localStorage.getItem("importHistory") || "[]"),
            salesHistory: JSON.parse(localStorage.getItem("salesHistory") || "[]")
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'backup-dong-phuc.json';
        a.click();
        URL.revokeObjectURL(url);
        showToast("ƒê√£ export d·ªØ li·ªáu th√†nh c√¥ng");
    }

    // H√†m import data
    function importData() {
        document.getElementById('importFile').click();
    }

    // X·ª≠ l√Ω s·ª± ki·ªán import file
    document.getElementById('importFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                localStorage.setItem("prices", JSON.stringify(data.prices || {}));
                localStorage.setItem("importTotals", JSON.stringify(data.importTotals || {}));
                localStorage.setItem("sellTotals", JSON.stringify(data.sellTotals || {}));
                localStorage.setItem("importHistory", JSON.stringify(data.importHistory || []));
                localStorage.setItem("salesHistory", JSON.stringify(data.salesHistory || []));
                
                location.reload(); // Reload ƒë·ªÉ √°p d·ª•ng d·ªØ li·ªáu m·ªõi
                showToast("ƒê√£ import d·ªØ li·ªáu th√†nh c√¥ng");
            } catch (error) {
                alert("L·ªói khi import d·ªØ li·ªáu: " + error.message);
            }
        };
        reader.readAsText(file);
    });

    initPrices(); renderProducts(); renderCart();
    showSection('prices');
  </script>
</body>
</html>